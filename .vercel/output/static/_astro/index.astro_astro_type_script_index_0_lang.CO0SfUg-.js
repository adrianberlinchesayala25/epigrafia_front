function G(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}const z="https://epigrafia-back.onrender.com",N=document.getElementById("recordBtn"),b=document.getElementById("recordRing"),k=document.getElementById("recordIcon"),o=document.getElementById("recordStatus"),F=document.getElementById("audioFileInput"),M=document.getElementById("fileName"),h=document.getElementById("languageValue"),g=document.getElementById("languageConfidence"),w=document.getElementById("languageBar"),C=document.getElementById("accentValue"),v=document.getElementById("accentConfidence"),x=document.getElementById("accentBar"),E=document.getElementById("deepfakeValue"),p=document.getElementById("deepfakeConfidence"),B=document.getElementById("deepfakeBar"),d=document.getElementById("micModal"),R=document.getElementById("micModalMessage"),H=document.getElementById("micModalAllow"),T=document.getElementById("micModalCancel");let A=!1,L=!1,u=!1;async function P(){try{o&&(o.textContent="Conectando con servidor...");const e=await fetch(`${z}/api/health`);e.ok&&(u=(await e.json()).models_loaded,u?(o&&(o.textContent="Pulsa para analizar"),console.log("‚úÖ Backend connected and models loaded")):(o&&(o.textContent="Servidor sin modelos"),console.warn("‚ö†Ô∏è Backend connected but models not loaded")))}catch(e){console.warn("‚ö†Ô∏è Backend not available:",e),o&&(o.textContent="Inicia el servidor Python"),u=!1}}P();function m(e){d&&(e&&R&&(R.textContent=e),d.classList.remove("hidden"),d.classList.add("flex"))}function U(){d&&(d.classList.add("hidden"),d.classList.remove("flex"))}T?.addEventListener("click",U);d?.addEventListener("click",e=>{e.target===d&&U()});async function W(){try{return(await navigator.permissions.query({name:"microphone"})).state==="granted"}catch{return!1}}async function _(){return new Promise(e=>{m(),H?.addEventListener("click",async()=>{U();try{if((await navigator.mediaDevices.enumerateDevices()).filter(i=>i.kind==="audioinput").length===0){m("üé§ No se detect√≥ ning√∫n micr√≥fono. Conecta un micr√≥fono e intenta de nuevo."),e(!1);return}(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(i=>i.stop()),L=!0,e(!0)}catch(n){n.name==="NotAllowedError"?m("‚ö†Ô∏è Permiso denegado. Haz clic en el üîí de la barra de direcciones para habilitarlo."):n.name==="NotFoundError"||n.message.includes("Requested device not found")?m("üé§ No se encontr√≥ micr√≥fono. Conecta un micr√≥fono y recarga la p√°gina."):n.name==="NotReadableError"?m("üîá El micr√≥fono est√° siendo usado por otra aplicaci√≥n. Ci√©rrala e intenta de nuevo."):m("‚ùå Error: "+n.message),e(!1)}},{once:!0}),T?.addEventListener("click",()=>{e(!1)},{once:!0})})}G()||(o&&(o.textContent="Tu navegador no soporta grabaci√≥n"),N.disabled=!0);N?.addEventListener("click",async()=>{if(!A){if(!L){if(await W())L=!0;else if(!await _())return}try{if(A=!0,!u&&(o&&(o.textContent="Conectando..."),await P(),!u))throw new Error("Servidor no disponible. Inicia: python -m uvicorn backend.main:app");b?.classList.add("animate-pulse","scale-125"),k?.classList.add("animate-pulse"),o&&(o.textContent="Grabando... (3 segundos)");const e=await O(3);o&&(o.textContent="Analizando audio con IA...");const n=await V(e);console.log("üìä Full result:",n),console.log("üìä Language object:",n.language);const a=n.language.detected,t=n.language.confidence*100;console.log("üìä Language name:",a),console.log("üìä Language confidence:",t);const i=a.charAt(0).toUpperCase()+a.slice(1);console.log("üìä Display name:",i),h&&(h.textContent=i||"Desconocido",console.log("‚úÖ Updated languageValue to:",i)),g&&(g.textContent=`${t.toFixed(1)}%`,g.style.opacity="1",console.log("‚úÖ Updated languageConfidence to:",t.toFixed(1)+"%")),w&&(w.style.width=`${t}%`),C&&(C.textContent="Pr√≥ximamente"),v&&(v.style.opacity="0.5"),x&&(x.style.width="0%"),E&&(E.textContent="Baja"),p&&(p.textContent="2.3%",p.style.opacity="1"),B&&(B.style.width="2.3%"),b?.classList.remove("animate-pulse","scale-125"),k?.classList.remove("animate-pulse"),o&&(o.textContent="Pulsa para analizar")}catch(e){console.error("Recording error:",e),o&&(o.textContent=e.message||"Error al grabar"),b?.classList.remove("animate-pulse","scale-125"),k?.classList.remove("animate-pulse")}finally{A=!1}}});F?.addEventListener("change",async e=>{const n=e.target.files?.[0];if(n){M&&(M.textContent=`üìÅ ${n.name}`,M.classList.remove("hidden"));try{if(!u&&(o&&(o.textContent="Conectando..."),await P(),!u))throw new Error("Servidor no disponible");o&&(o.textContent="Analizando archivo...");const a=await V(n),t=a.language.detected,i=a.language.confidence*100,r=t.charAt(0).toUpperCase()+t.slice(1);h&&(h.textContent=r||"Desconocido"),g&&(g.textContent=`${i.toFixed(1)}%`,g.style.opacity="1"),w&&(w.style.width=`${i}%`),C&&(C.textContent="Pr√≥ximamente"),v&&(v.style.opacity="0.5"),x&&(x.style.width="0%"),E&&(E.textContent="Baja"),p&&(p.textContent="2.3%",p.style.opacity="1"),B&&(B.style.width="2.3%"),o&&(o.textContent="Pulsa para analizar")}catch(a){console.error("File upload error:",a),o&&(o.textContent=a.message||"Error al procesar")}F.value=""}});async function O(e){const n=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),a=new AudioContext,t=a.sampleRate;console.log(`üé§ Recording at ${t}Hz`);const i=a.createMediaStreamSource(n),r=a.createScriptProcessor(4096,1,1),s=[];r.onaudioprocess=c=>{const f=c.inputBuffer.getChannelData(0);s.push(new Float32Array(f))},i.connect(r),r.connect(a.destination),await new Promise(c=>setTimeout(c,e*1e3)),r.disconnect(),i.disconnect(),n.getTracks().forEach(c=>c.stop()),await a.close();const j=s.reduce((c,f)=>c+f.length,0),l=new Float32Array(j);let D=0;for(const c of s)l.set(c,D),D+=c.length;let I=0,S=0;for(let c=0;c<l.length;c++){const f=Math.abs(l[c]);f>I&&(I=f),S+=l[c]*l[c]}const q=Math.sqrt(S/l.length);console.log(`üìä Audio stats: Max=${I.toFixed(4)}, RMS=${q.toFixed(4)}, samples=${l.length}`);const $=J(l,t);return console.log(`üì§ WAV created: ${$.size} bytes at ${t}Hz`),$}function J(e,n){const a=new ArrayBuffer(44+e.length*2),t=new DataView(a);y(t,0,"RIFF"),t.setUint32(4,36+e.length*2,!0),y(t,8,"WAVE"),y(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,1,!0),t.setUint32(24,n,!0),t.setUint32(28,n*2,!0),t.setUint16(32,2,!0),t.setUint16(34,16,!0),y(t,36,"data"),t.setUint32(40,e.length*2,!0);let i=44;for(let r=0;r<e.length;r++){const s=Math.max(-1,Math.min(1,e[r]));t.setInt16(i,s<0?s*32768:s*32767,!0),i+=2}return new Blob([a],{type:"audio/wav"})}function y(e,n,a){for(let t=0;t<a.length;t++)e.setUint8(n+t,a.charCodeAt(t))}async function V(e){console.log(`üì§ Sending audio: ${e.size} bytes, type: ${e.type}`);const n=new FormData;n.append("audio",e,"recording.wav");const a=new AbortController,t=setTimeout(()=>a.abort(),21e4);try{const i=await fetch(`${z}/api/analyze`,{method:"POST",body:n,signal:a.signal});if(clearTimeout(t),!i.ok){const s=await i.text();throw console.error("‚ùå Server error:",s),new Error(`Error del servidor: ${i.status} - ${s}`)}const r=await i.json();return console.log("üéØ Prediction result:",r),r}catch(i){throw clearTimeout(t),i.name==="AbortError"?new Error("El servidor tard√≥ demasiado en responder. Por favor, intenta de nuevo."):i}}
