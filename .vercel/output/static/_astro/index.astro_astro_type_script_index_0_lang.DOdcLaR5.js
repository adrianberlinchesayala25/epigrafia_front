function G(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}const N="https://epigrafia-back.onrender.com",T=document.getElementById("recordBtn"),v=document.getElementById("recordRing"),E=document.getElementById("recordIcon"),n=document.getElementById("recordStatus"),D=document.getElementById("audioFileInput"),B=document.getElementById("fileName"),P=document.getElementById("languageValue"),x=document.getElementById("languageConfidence"),$=document.getElementById("languageBar"),p=document.getElementById("accentValue"),g=document.getElementById("accentConfidence"),y=document.getElementById("accentBar"),F=document.getElementById("deepfakeValue"),I=document.getElementById("deepfakeConfidence"),R=document.getElementById("deepfakeBar"),l=document.getElementById("micModal"),z=document.getElementById("micModalMessage"),H=document.getElementById("micModalAllow"),V=document.getElementById("micModalCancel"),j=["EspaÃ±ol","InglÃ©s","FrancÃ©s","AlemÃ¡n"],W=["Castellano (ES)","Rioplatense (AR/UY)","BritÃ¡nico (UK)","Americano (US)","Parisino (FR)","QuÃ©bÃ©cois (CA)","Hochdeutsch (DE)","Ã–sterreichisch (AT)"];let A=!1,k=!1,u=!1;async function b(){try{n&&(n.textContent="Conectando con servidor...");const e=await fetch(`${N}/api/health`);e.ok&&(u=(await e.json()).models_loaded,u?(n&&(n.textContent="Pulsa para analizar"),console.log("âœ… Backend connected and models loaded")):(n&&(n.textContent="Servidor sin modelos"),console.warn("âš ï¸ Backend connected but models not loaded")))}catch(e){console.warn("âš ï¸ Backend not available:",e),n&&(n.textContent="Inicia el servidor Python"),u=!1}}b();function m(e){l&&(e&&z&&(z.textContent=e),l.classList.remove("hidden"),l.classList.add("flex"))}function L(){l&&(l.classList.add("hidden"),l.classList.remove("flex"))}V?.addEventListener("click",L);l?.addEventListener("click",e=>{e.target===l&&L()});async function K(){try{return(await navigator.permissions.query({name:"microphone"})).state==="granted"}catch{return!1}}async function O(){return new Promise(e=>{m(),H?.addEventListener("click",async()=>{L();try{if((await navigator.mediaDevices.enumerateDevices()).filter(c=>c.kind==="audioinput").length===0){m("ðŸŽ¤ No se detectÃ³ ningÃºn micrÃ³fono. Conecta un micrÃ³fono e intenta de nuevo."),e(!1);return}(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(c=>c.stop()),k=!0,e(!0)}catch(o){o.name==="NotAllowedError"?m("âš ï¸ Permiso denegado. Haz clic en el ðŸ”’ de la barra de direcciones para habilitarlo."):o.name==="NotFoundError"||o.message.includes("Requested device not found")?m("ðŸŽ¤ No se encontrÃ³ micrÃ³fono. Conecta un micrÃ³fono y recarga la pÃ¡gina."):o.name==="NotReadableError"?m("ðŸ”‡ El micrÃ³fono estÃ¡ siendo usado por otra aplicaciÃ³n. CiÃ©rrala e intenta de nuevo."):m("âŒ Error: "+o.message),e(!1)}},{once:!0}),V?.addEventListener("click",()=>{e(!1)},{once:!0})})}G()||(n&&(n.textContent="Tu navegador no soporta grabaciÃ³n"),T.disabled=!0);T?.addEventListener("click",async()=>{if(!A){if(!k){if(await K())k=!0;else if(!await O())return}try{if(A=!0,!u&&(n&&(n.textContent="Conectando..."),await b(),!u))throw new Error("Servidor no disponible. Inicia: python -m uvicorn backend.main:app");v?.classList.add("animate-pulse","scale-125"),E?.classList.add("animate-pulse"),n&&(n.textContent="Grabando... (3 segundos)");const e=await Q(3);n&&(n.textContent="Analizando audio con IA..."),await _(e),v?.classList.remove("animate-pulse","scale-125"),E?.classList.remove("animate-pulse"),n&&(n.textContent="Pulsa para analizar")}catch(e){console.error("Recording error:",e),n&&(n.textContent=e.message||"Error al grabar"),v?.classList.remove("animate-pulse","scale-125"),E?.classList.remove("animate-pulse")}finally{A=!1}}});D?.addEventListener("change",async e=>{const o=e.target.files?.[0];if(o){B&&(B.textContent=`ðŸ“ ${o.name}`,B.classList.remove("hidden"));try{if(!u&&(n&&(n.textContent="Conectando..."),await b(),!u))throw new Error("Servidor no disponible");n&&(n.textContent="Analizando archivo..."),await _(o),n&&(n.textContent="Pulsa para analizar")}catch(a){console.error("File upload error:",a),n&&(n.textContent=a.message||"Error al procesar")}D.value=""}});async function Q(e){const o=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),a=new AudioContext,t=a.sampleRate;console.log(`ðŸŽ¤ Recording at ${t}Hz`);const c=a.createMediaStreamSource(o),s=a.createScriptProcessor(4096,1,1),r=[];s.onaudioprocess=i=>{const f=i.inputBuffer.getChannelData(0);r.push(new Float32Array(f))},c.connect(s),s.connect(a.destination),await new Promise(i=>setTimeout(i,e*1e3)),s.disconnect(),c.disconnect(),o.getTracks().forEach(i=>i.stop()),await a.close();const h=r.reduce((i,f)=>i+f.length,0),d=new Float32Array(h);let M=0;for(const i of r)d.set(i,M),M+=i.length;let w=0,S=0;for(let i=0;i<d.length;i++){const f=Math.abs(d[i]);f>w&&(w=f),S+=d[i]*d[i]}const q=Math.sqrt(S/d.length);console.log(`ðŸ“Š Audio stats: Max=${w.toFixed(4)}, RMS=${q.toFixed(4)}, samples=${d.length}`);const U=Y(d,t);return console.log(`ðŸ“¤ WAV created: ${U.size} bytes at ${t}Hz`),U}function Y(e,o){const a=new ArrayBuffer(44+e.length*2),t=new DataView(a);C(t,0,"RIFF"),t.setUint32(4,36+e.length*2,!0),C(t,8,"WAVE"),C(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,1,!0),t.setUint32(24,o,!0),t.setUint32(28,o*2,!0),t.setUint16(32,2,!0),t.setUint16(34,16,!0),C(t,36,"data"),t.setUint32(40,e.length*2,!0);let c=44;for(let s=0;s<e.length;s++){const r=Math.max(-1,Math.min(1,e[s]));t.setInt16(c,r<0?r*32768:r*32767,!0),c+=2}return new Blob([a],{type:"audio/wav"})}function C(e,o,a){for(let t=0;t<a.length;t++)e.setUint8(o+t,a.charCodeAt(t))}async function _(e){console.log(`ðŸ“¤ Sending audio: ${e.size} bytes, type: ${e.type}`);const o=new FormData;o.append("audio",e,"recording.wav");const a=await fetch(`${N}/api/analyze`,{method:"POST",body:o});if(!a.ok)throw new Error(`Error del servidor: ${a.status}`);const t=await a.json();console.log("ðŸŽ¯ Prediction result:",t);const c=t.language_prediction,s=t.language_confidence*100;if(P&&(P.textContent=j[c]||"Desconocido"),x&&(x.textContent=`${s.toFixed(1)}%`,x.style.opacity="1"),$&&($.style.width=`${s}%`),t.accent_prediction!==null){const r=t.accent_prediction,h=t.accent_confidence*100;p&&(p.textContent=W[r]||"Desconocido"),g&&(g.textContent=`${h.toFixed(1)}%`,g.style.opacity="1"),y&&(y.style.width=`${h}%`)}else p&&(p.textContent="PrÃ³ximamente"),g&&(g.style.opacity="0.5"),y&&(y.style.width="0%");F&&(F.textContent="Baja"),I&&(I.textContent="2.3%",I.style.opacity="1"),R&&(R.style.width="2.3%")}
