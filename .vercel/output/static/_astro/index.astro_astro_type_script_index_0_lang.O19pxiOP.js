function q(){return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)}const z=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"http://localhost:8000":"https://epigrafia-back.onrender.com",_=document.getElementById("recordBtn"),B=document.getElementById("recordRing"),b=document.getElementById("recordIcon"),n=document.getElementById("recordStatus"),F=document.getElementById("audioFileInput"),I=document.getElementById("fileName"),P=document.getElementById("languageValue"),A=document.getElementById("languageConfidence"),N=document.getElementById("languageBar"),x=document.getElementById("accentValue"),w=document.getElementById("accentConfidence"),C=document.getElementById("accentBar"),u=document.getElementById("deepfakeValue"),f=document.getElementById("deepfakeConfidence"),g=document.getElementById("deepfakeBar"),m=document.getElementById("micModal"),R=document.getElementById("micModalMessage"),G=document.getElementById("micModalAllow"),T=document.getElementById("micModalCancel"),W=["EspaÃ±ol","InglÃ©s","FrancÃ©s","AlemÃ¡n"],j=["Castellano (ES)","Rioplatense (AR/UY)","BritÃ¡nico (UK)","Americano (US)","Parisino (FR)","QuÃ©bÃ©cois (CA)","Hochdeutsch (DE)","Ã–sterreichisch (AT)"];let k=!1,L=!1,y=!1;async function M(){try{n&&(n.textContent="Conectando con servidor...");const e=await fetch(`${z}/api/health`);if(e.ok){const o=await e.json();y=o.status==="healthy",o.models_loaded?(n&&(n.textContent="Pulsa para analizar"),console.log("âœ… Backend connected and models loaded")):(n&&(n.textContent="Pulsa para analizar"),console.log("âœ… Backend connected (lazy loading mode)"))}}catch(e){console.warn("âš ï¸ Backend not available:",e),n&&(n.textContent="Servidor no disponible"),y=!1}}M();function h(e){m&&(e&&R&&(R.textContent=e),m.classList.remove("hidden"),m.classList.add("flex"))}function S(){m&&(m.classList.add("hidden"),m.classList.remove("flex"))}T?.addEventListener("click",S);m?.addEventListener("click",e=>{e.target===m&&S()});async function K(){try{return(await navigator.permissions.query({name:"microphone"})).state==="granted"}catch{return!1}}async function O(){return new Promise(e=>{h(),G?.addEventListener("click",async()=>{S();try{if((await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="audioinput").length===0){h("ðŸŽ¤ No se detectÃ³ ningÃºn micrÃ³fono. Conecta un micrÃ³fono e intenta de nuevo."),e(!1);return}(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(r=>r.stop()),L=!0,e(!0)}catch(o){o.name==="NotAllowedError"?h("âš ï¸ Permiso denegado. Haz clic en el ðŸ”’ de la barra de direcciones para habilitarlo."):o.name==="NotFoundError"||o.message.includes("Requested device not found")?h("ðŸŽ¤ No se encontrÃ³ micrÃ³fono. Conecta un micrÃ³fono y recarga la pÃ¡gina."):o.name==="NotReadableError"?h("ðŸ”‡ El micrÃ³fono estÃ¡ siendo usado por otra aplicaciÃ³n. CiÃ©rrala e intenta de nuevo."):h("âŒ Error: "+o.message),e(!1)}},{once:!0}),T?.addEventListener("click",()=>{e(!1)},{once:!0})})}q()||(n&&(n.textContent="Tu navegador no soporta grabaciÃ³n"),_.disabled=!0);_?.addEventListener("click",async()=>{if(!k){if(!L){if(await K())L=!0;else if(!await O())return}try{if(k=!0,!y&&(n&&(n.textContent="Conectando..."),await M(),!y))throw new Error("Servidor no disponible. Inicia: python -m uvicorn backend.main:app");B?.classList.add("animate-pulse","scale-125"),b?.classList.add("animate-pulse"),n&&(n.textContent="Grabando... (3 segundos)");const e=await Q(3);n&&(n.textContent="Analizando audio con IA..."),await V(e),B?.classList.remove("animate-pulse","scale-125"),b?.classList.remove("animate-pulse"),n&&(n.textContent="Pulsa para analizar")}catch(e){console.error("Recording error:",e),n&&(n.textContent=e.message||"Error al grabar"),B?.classList.remove("animate-pulse","scale-125"),b?.classList.remove("animate-pulse")}finally{k=!1}}});F?.addEventListener("change",async e=>{const o=e.target.files?.[0];if(o){I&&(I.textContent=`ðŸ“ ${o.name}`,I.classList.remove("hidden"));try{if(!y&&(n&&(n.textContent="Conectando..."),await M(),!y))throw new Error("Servidor no disponible");n&&(n.textContent="Analizando archivo..."),await V(o),n&&(n.textContent="Pulsa para analizar")}catch(a){console.error("File upload error:",a),n&&(n.textContent=a.message||"Error al procesar")}F.value=""}});async function Q(e){const o=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),a=new AudioContext,t=a.sampleRate;console.log(`ðŸŽ¤ Recording at ${t}Hz`);const r=a.createMediaStreamSource(o),l=a.createScriptProcessor(4096,1,1),s=[];l.onaudioprocess=i=>{const p=i.inputBuffer.getChannelData(0);s.push(new Float32Array(p))},r.connect(l),l.connect(a.destination),await new Promise(i=>setTimeout(i,e*1e3)),l.disconnect(),r.disconnect(),o.getTracks().forEach(i=>i.stop()),await a.close();const c=s.reduce((i,p)=>i+p.length,0),d=new Float32Array(c);let $=0;for(const i of s)d.set(i,$),$+=i.length;let E=0,U=0;for(let i=0;i<d.length;i++){const p=Math.abs(d[i]);p>E&&(E=p),U+=d[i]*d[i]}const H=Math.sqrt(U/d.length);console.log(`ðŸ“Š Audio stats: Max=${E.toFixed(4)}, RMS=${H.toFixed(4)}, samples=${d.length}`);const D=Y(d,t);return console.log(`ðŸ“¤ WAV created: ${D.size} bytes at ${t}Hz`),D}function Y(e,o){const a=new ArrayBuffer(44+e.length*2),t=new DataView(a);v(t,0,"RIFF"),t.setUint32(4,36+e.length*2,!0),v(t,8,"WAVE"),v(t,12,"fmt "),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,1,!0),t.setUint32(24,o,!0),t.setUint32(28,o*2,!0),t.setUint16(32,2,!0),t.setUint16(34,16,!0),v(t,36,"data"),t.setUint32(40,e.length*2,!0);let r=44;for(let l=0;l<e.length;l++){const s=Math.max(-1,Math.min(1,e[l]));t.setInt16(r,s<0?s*32768:s*32767,!0),r+=2}return new Blob([a],{type:"audio/wav"})}function v(e,o,a){for(let t=0;t<a.length;t++)e.setUint8(o+t,a.charCodeAt(t))}async function V(e){console.log(`ðŸ“¤ Sending audio: ${e.size} bytes, type: ${e.type}`);const o=new FormData;o.append("audio",e,"recording.wav");const a=await fetch(`${z}/api/analyze`,{method:"POST",body:o});if(!a.ok)throw new Error(`Error del servidor: ${a.status}`);const t=await a.json();console.log("ðŸŽ¯ Prediction result:",t);const r=t.language_prediction,l=t.language_confidence*100;if(P&&(P.textContent=W[r]||"Desconocido"),A&&(A.textContent=`${l.toFixed(1)}%`,A.style.opacity="1"),N&&(N.style.width=`${l}%`),t.accent_prediction!==null){const s=t.accent_prediction,c=t.accent_confidence*100;x&&(x.textContent=j[s]||"Desconocido"),w&&(w.textContent=`${c.toFixed(1)}%`,w.style.opacity="1"),C&&(C.style.width=`${c}%`)}else x&&(x.textContent="PrÃ³ximamente"),w&&(w.style.opacity="0.5"),C&&(C.style.width="0%");if(t.spoofing){const s=t.spoofing,c=s.spoof_probability*100,d=s.is_genuine;u&&(d?(u.textContent="Humano",u.classList.remove("text-red-400"),u.classList.add("text-green-400")):(u.textContent="Artificial",u.classList.remove("text-green-400"),u.classList.add("text-red-400"))),f&&(f.textContent=`${c.toFixed(1)}%`,f.style.opacity="1",c<30?f.className="px-3 py-1 text-sm font-semibold rounded-md bg-green-500/20 text-green-400":c<70?f.className="px-3 py-1 text-sm font-semibold rounded-md bg-yellow-500/20 text-yellow-400":f.className="px-3 py-1 text-sm font-semibold rounded-md bg-red-500/20 text-red-400"),g&&(g.style.width=`${c}%`,c<30?g.className="h-full bg-gradient-to-r from-green-500 to-emerald-400 rounded-full transition-all duration-700":c<70?g.className="h-full bg-gradient-to-r from-yellow-500 to-orange-400 rounded-full transition-all duration-700":g.className="h-full bg-gradient-to-r from-pink-500 to-red-400 rounded-full transition-all duration-700"),console.log(`ðŸ” Spoofing: ${s.label} (${c.toFixed(1)}% artificial)`)}else u&&(u.textContent="No disponible"),f&&(f.textContent="â€”",f.style.opacity="0.5"),g&&(g.style.width="0%")}
